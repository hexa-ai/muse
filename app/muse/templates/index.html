<html>
    <head>
        <link rel='stylesheet' href='./static/css/normalize.css'>
        <script src='https://cdn.socket.io/socket.io-1.4.5.js'></script>
        <script type='text/javascript' src='./static/js/audioengine.js'></script>
        <script type='text/javascript' src='./static/js/sequencer-ui.js'></script>
        <script type='text/javascript' charset='utf-8'>
            // ---------------------------------------------------------------- 
            // Setup the Audio Engine
            var engine = AudioEngine();
            var sequencer = StepSequencer();
            var sequencerUIs = [];
            var compositionId = 0;
            engine.connect(sequencer);
            
            // ---------------------------------------------------------------- 
            // SocketIO Handlers
            var socket = io.connect('http://' + document.domain + ':' + location.port);
            socket.on('connect', function() {
                console.log('Connected');
            });

            socket.on('composition_init', function(data) {
                compositionId = compositionId || data['composition_id']; 
            });

            setInterval(function() {
                for(var i = 0; i < sequencerUIs.length; i++) {
                    if(sequencerUIs[i].aiToggle.checked) {
                        console.log(compositionId);
                        socket.emit('request_ai_sequence', {composition_id: compositionId});
                    }
                } 
            }, 1000);

            socket.on('response_new_sequence', function(data) {
                    console.log(data);
                // Create a new sample bank
                var sampleBank = new SampleBank(engine.ctx);
                
                // Load the set of samples
                // Add a callback to handle the successful loading of all samples
                sampleBank.loadAll(data['voices'], 
                    function success() {
                        var voices = data['voices'];
                        var sequenceId = data['_id']['$oid'];
                        var sequenceName = data['name'];

                        // Add voices to the sequencer
                        // Use a special voice-id property as a key for the voice
                        // This id is a the name of the voice + the sequence id
                        var voiceIds = [];
                        for (var voice in voices) {
                            var voiceName = voices[voice]['name'];
                            var voiceId = voiceName + '-' + sequenceId;
                            voices[voice]['voiceId'] = voiceId;
                            voiceIds.push(voiceId);
                            sequencer.addVoice(voiceId, voiceName, sampleBank.samples[voiceName])
                        }

                        // Create the new sequencer UI 
                        var ui = new SequencerUI(document.getElementById('sequencer'), sequencer, sequenceName, voices);

                        // Add listeners for save
                        ui.saveButton.addEventListener('click', function(event) {
                            var toggleData = "";
                            var voices = sequencer.getVoices(voiceIds);
                            for(var i in voices) {
                                var toggles = voices[i]['toggles']
                                if(toggles) {
                                    for(var j in toggles) {
                                        toggleData += toggles[j];
                                    }
                                }
                            }

                            socket.emit('sequence_data_update', {sequence_id : sequenceId, data : toggleData})
                        });

                        ui.aiToggle.addEventListener('click', function(event) {
                            socket.emit('sequence_ai_update', {sequence_id : sequenceId, ai : ui.aiToggle.checked});
                        });

                        // Add listeners for name change
                        ui.nameInput.addEventListener('blur', function(event) {
                            var name = event.target.value;
                            if(name != '') {
                                socket.emit('sequence_name_update', {sequence_id : sequenceId, name : event.target.value})
                            }
                        });

                        // Add to list of sequencer uis
                        sequencerUIs.push(ui);
                    }, 
                    function error() {
                        console.log('Error loading sample bank');                         
                    }); 
            });

            // ---------------------------------------------------------------- 
            // UI Handlers
            window.onload = function() {
                var instrumentSelect = document.getElementById('instrument-select');
                var createInstrumentButton = document.getElementById('create-instrument-btn');


                createInstrumentButton.addEventListener('click', function(event) {
                    socket.emit('request_new_sequence', {
                        'composition_id' : compositionId, 
                        'instrument' : instrumentSelect.value
                    });
                });

                var btn = document.getElementById("play-stop-btn");
                btn.addEventListener("click", function(event) {
                    switch(engine.getState()) {
                        case 'started':
                            engine.stop();
                            btn.value = 'Play';
                        break;
                        case 'stopped':
                            engine.start();
                            btn.value = 'Stop';
                        break;
                    }
                });

                var btn = document.getElementById('update-models-btn');
                btn.addEventListener('click', function(event) {
                    socket.emit('update_models');
                });

                var tempoSlider = document.getElementById("tempo-slider");
                tempoSlider.addEventListener("input", function(event) {
                    sequencer.setTempo(tempoSlider.value);
                });

                var volumeSlider = document.getElementById("volume-slider");
                volumeSlider.addEventListener("input", function(event) {
                    engine.setAmplitude(volumeSlider.value);
                });

                function updateInfo() {
                    requestAnimationFrame(updateInfo);
                    var t = engine.getCurrentTime();
                    var currentStep = sequencer.getCurrentStep();
                    var totalSteps = sequencer.getSteps();
                    var div = document.getElementById('info');
                    var quaterNote =  1 + Math.floor(currentStep / 4) % 4;
                    var measure = 1 + Math.floor(currentStep / 16);
                    div.innerHTML = "Current Time: " + 
                        parseFloat(t).toFixed(2) + 
                        "<br/>Tempo: " + sequencer.getTempo() + 
                        "<br/>Steps: " + sequencer.getSteps() +
                        "<br/>" + quaterNote +":" +  measure;

                    for(var i = 0; i < sequencerUIs.length; i++) {
                        sequencerUIs[i].setStep(currentStep % totalSteps);
                    }
                }
                updateInfo();
            }
        </script>
    </head>
    <body>
        <h1>Muse</h1><h2>by HEXA</h2><p>Please contact your local bot</p>
        <input type="button" id="play-stop-btn" value="Play"></input>
        <p>Tempo: <input type="range" id="tempo-slider" value="120" step="1" min="45" max="270"></p>
        <p>Volume: <input type="range" id="volume-slider" step="0.01" value="0.5" min="0.0" max="0.8"></p>
        <div id="info">Info here</div>
        <input type='button' id='update-models-btn' value='Update Models'></input>
        <h3>Create New Instrument</h3>
        <div>
            <select id='instrument-select'>
                {% for instrument in instruments %}
                <option text="{{ instrument['name'] }}" value="{{ instrument['_id'] }}">{{ instrument['name'] }}</option>
                {% endfor %}
            </select>
            <input id='create-instrument-btn' type='button' value='Create'></input>
        </div>
        <br/>
        <div id="sequencer"></div>
    </body>
</html>
