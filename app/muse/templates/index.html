<html>
    <head>
        <script src='https://cdn.socket.io/socket.io-1.4.5.js'></script>
        <script type='text/javascript' src='./static/js/audioengine.js'></script>
        <script type='text/javascript' src='./static/js/sequencer-ui.js'></script>
        <script type='text/javascript' charset='utf-8'>
            // ---------------------------------------------------------------- 
            // Setup the Audio Engine
            var engine = AudioEngine();
            var sequencer = StepSequencer();
            var sequencerUIs = [];
            engine.connect(sequencer);
            
            // ---------------------------------------------------------------- 
            // SocketIO Handlers
            var socket = io.connect('http://' + document.domain + ':' + location.port);
            socket.on('connect', function() {
                console.log('Connected');
            });

            socket.on('composition_init', function(data) {
                compositionId = data['composition_id']; 
            });

            socket.on('response_new_sequence', function(data) {
                var sampleBank = new SampleBank(engine.ctx);
                sampleBank.loadAll(data['voices'], 
                    function success() {
                        var voices = data['voices'];
                        var sequenceId = data['_id']['$oid'];
                        var sequenceName = data['name'];

                        var voiceIds = [];
                        for (var voice in voices) {
                            var voiceName = voices[voice]['name'];
                            var voiceId = voiceName + '-' + sequenceId;
                            voices[voice]['voiceId'] = voiceId;
                            voiceIds.push(voiceId);
                            sequencer.addVoice(voiceId, voiceName, sampleBank.samples[voiceName])
                        }
                         
                        var ui = new SequencerUI(document.getElementById('sequencer'), sequencer, sequenceName, voices)
                        ui.saveButton.addEventListener('click', function(event) {
                            var toggleData = "";
                            var voices = sequencer.getVoices(voiceIds);
                            for(var i in voices) {
                                var toggles = voices[i]['toggles']
                                if(toggles) {
                                    for(var j in toggles) {
                                        toggleData += toggles[j];
                                    }
                                }
                            }
                            console.log(toggleData);
                        });
                        sequencerUIs.push(ui);
                    }, 
                    function error() {
                        console.log('Error loading sample bank');                         
                    }); 
            });

            // ---------------------------------------------------------------- 
            // UI Handlers
            window.onload = function() {
                var instrumentSelect = document.getElementById('instrument-select');
                var createInstrumentButton = document.getElementById('create-instrument-btn');


                createInstrumentButton.addEventListener('click', function(event) {
                    socket.emit('request_new_sequence', {
                        'composition_id' : compositionId, 
                        'instrument' : instrumentSelect.value
                    });
                });

                var btn = document.getElementById("play-stop-btn");
                btn.addEventListener("click", function(event) {
                    switch(engine.getState()) {
                        case 'started':
                            engine.stop();
                            btn.value = 'Play';
                        break;
                        case 'stopped':
                            engine.start();
                            btn.value = 'Stop';
                        break;
                    }
                });

                var tempoSlider = document.getElementById("tempo-slider");
                tempoSlider.addEventListener("input", function(event) {
                    sequencer.setTempo(tempoSlider.value);
                });

                var volumeSlider = document.getElementById("volume-slider");
                volumeSlider.addEventListener("input", function(event) {
                    engine.setAmplitude(volumeSlider.value);
                });

                var saveBtn = document.getElementById('save-btn');
                saveBtn.addEventListener('click', function(event) {
                    var voices = sequencer.getVoices();
                    var toggleData = "";
                    for(var i in voices) {
                        var toggles = voices[i]['toggles']
                        if(toggles) {
                            for(var j in toggles) {
                                toggleData += toggles[j];
                            }
                        }
                    }  

                    console.log(toggleData); 
                    socket.emit('save_composition', {

                    });
                });

                function updateInfo() {
                    requestAnimationFrame(updateInfo);
                    var t = engine.getCurrentTime();
                    var currentStep = sequencer.getCurrentStep();
                    var totalSteps = sequencer.getSteps();
                    var div = document.getElementById('info');
                    var quaterNote =  1 + Math.floor(currentStep / 4) % 4;
                    var measure = 1 + Math.floor(currentStep / 16);
                    div.innerHTML = "Current Time: " + 
                        parseFloat(t).toFixed(2) + 
                        "<br/>Tempo: " + sequencer.getTempo() + 
                        "<br/>Steps: " + sequencer.getSteps() +
                        "<br/>" + quaterNote +":" +  measure;

                    for(var i = 0; i < sequencerUIs.length; i++) {
                        sequencerUIs[i].setStep(currentStep % totalSteps);
                    }
                }
                updateInfo();
            }
        </script>
    </head>
    <body>
        <h1>Muse</h1><h2>by HEXA</h2><p>Please contact your local bot</p>
        <input type="button" id="play-stop-btn" value="Play"></input>
        <p>Tempo: <input type="range" id="tempo-slider" value="120" step="1" min="45" max="270"></p>
        <p>Volume: <input type="range" id="volume-slider" step="0.01" value="0.5" min="0.0" max="0.8"></p>
        <div id="info">Info here</div>

        <h3>Create New Instrument</h3>
        <div>
            <select id='instrument-select'>
                {% for instrument in instruments %}
                <option text="{{ instrument['name'] }}" value="{{ instrument['_id'] }}">{{ instrument['name'] }}</option>
                {% endfor %}
            </select>
            <input id='create-instrument-btn' type='button' value='Create'></input>
            <input id='save-btn' type='button' value='Save'></input>
        </div>
        <div id="sequencer"></div>
    </body>
</html>
